## 싱글톤 레지스트리와 오브젝트 스코프

### 오브젝트의 동일성과 동등성

- 두 개의 오브젝트가 동일하다면 (동일성) 하나의 오브젝트만 존재하고, 두개의 오브젝트는 레퍼런스 변수만 갖고 있음 = 두 레퍼런스가 같은 객체(메모리의 주소)를 가리킬 때
- 두 개의 오브젝트가 동일하지는 않지만 동등할 경우 (동등성) 각기 다른 오브젝트가 메모리상 존재함 = 객체는 다르지만 내부 데이터가 같은 경우
- 애플리케이션 컨텍스트에서 등록된 빈을 getBean() 두 번 했을 때 가져온 오브젝트가 동일함

### 애플리케이션 컨텍스트는 싱글톤을 저장하고 관리하는 싱글톤 레지스트리임

- 스프링은 내부에 생성하는 빈 오브젝트를 모두 싱글톤으로 만듬
- 왜 싱글톤으로 만듬 ? 스프링이 주로 적용하는 대상은 자바 엔터프라이즈 기술을 사용하는 서버 기술이기 때문 → 매번 클라이언트 요청이 올 때마다 오브젝트를 매번 생성해 사용한다면 서버에 부하가 감
- 서블릿은 자바 엔터프라이즈 기술의 가장 기본이 되는 서비스 오브젝트라고 할 수 있음
  - 서블릿은 클라이언트 요청을 받아 처리하고 그에 대한 응답을 만드는 자바 기반의 서버 측 프로그램임 (웹 서버에서 실행되는 자바 객체)
  - 서블릿은 대부분 멀티스레드 환경에서 싱글톤으로 동작함 = 여러 스레드에서 하나의 오브젝트를 공유

### 자바에서 싱글톤 구현 방법

- 클래스 밖으로 오브젝트를 생성하지 못하도록 생성자 private으로 만듬
- 생성된 싱글톤 오브젝트를 저장할 수 있는 자신과 같은 타입의 스태틱 필드 정의
- 스태틱 팩토리 메소드인 getInstance를 만듬

### 싱글톤 패턴의 한계

- private 생성자를 갖고 있기 때문에 상속할 수 없음
  - 객체지향적인 설계의 장점을 적용하기 어려움
- 테스트하기가 힘듬
  - 일반적으로 테스트에서는 Mock 객체를 주입해 테스트 용이성을 높임
  - 싱글톤은 내부에 의존 객체가 고정되어 있거나 생성자 주입이 불가능해 테스트 어려움
- 서버 환경에서는 싱글톤이 하나만 만들어지는것을 보장하지 못함
  - 클래스 로더가 여러개 존재하는 경우 서로 다른 싱글톤 인스턴스가 생성될 수 있음
  - 클래스로더란 자바 바이트 코드를 jvm 메모리 영역에 로드해서 사용할 수 있도록 만드는 역할임
  - 멀티 JVM 환경일 경우 서버마다 하나씩 싱글톤 객체가 생성됨
- 전역상태를 만들 수 있기 때문에 바람직하지 못함
  - 아무 객체나 자유롭게 접근하고 수정하고 공유할 수 있는 전역상태를 갖는것은 객체지향 프로그래밍에서는 권장되지 않음

### 스프링은 직접 싱글톤 형태의 오브젝트를 만들고 관리하는 기능을 제공함

- 평범한 자바 클래스도 IoC 컨테이너에게 제어권을넘기면 싱글톤 방식으로 관리할 수 있음
- public 생성자를 가질 수 있음
- 고전적인 싱글톤 패턴을 대신해서 싱글톤을 만들고 관리해줌

### 싱글톤으로 만들어지기 때문에 주의할 점

- 멀티스레드 환경이라면 여러 스레드가 접근하여 사용할 수 있어 상태 관리에 신경써야함
- 상태 정보를 내부에 갖고 있지 않은 무상태 방식으로 만들어져야함
- 요청에 따른 정보(DB 조회 결과, 사용자 입력 등)는 메서드의 파라미터, 로컬 변수, 리턴값으로만 처리한다.
- 싱글톤 객체라도, 메서드 파라미터나 지역 변수는 각 스레드마다 별도의 메모리 공간이 생성되므로 충돌이 없다.
- 스프링이 한 번 초기화해주고 이후 수정되지 않는 인스턴스나 읽기 전용이라면 인스턴스 변수로 사용해도 괜찮음

### 스프링 빈 스코프

- 빈의 스코프 : 빈이 생성되고, 존재하고, 적용되는 범위
- 기본 스코프는 싱글톤임
- 프로토 타입 스코프 : 싱글톤과 달리 컨테이너에 빈을 요청할 때마다 매번 새로운 오브젝트를 만들어줌
- 요청 스코프 : 웹을 통해 새로운 HTTP 요청이 생길 때마다 생성됨

### 자문자답

- 멀티 모듈과 클래스 로더는 같은 개념인가?
  - X , 멀티모듈은 개발과 빌드 시점에서의 구조를 의미하고, 클래스 로더는 JVM이 실행되는 시점에서 .class 파일을 메모리에 로딩하는 메커니즘임
- 멀티모듈이면 클래스 로더도 여러 개인가?
  - X , 보통 하나의 .jar 또는 .war로 묶여 배포되기 때문에 클래스 로더는 하나로 동작함
- 클래스 로더가 여러 개인 경우는 언제인가?
  - 톰캣 같은 WAS에서 .war 파일마다 별도의 클래스 로더를 사용해 애플리케이션을 격리할 때
  - war파일 : 웹 애플리케이션을 배포할 수 있는 압축된 형태의 파일 , 전통적인 스프링은 war+톰캣
  - 스프링부트는 내장 톰캣을 통해 jar파일만으로도 실행 가능함 , 일반적으로 클래스 로더 1개
- 클래스 로더가 다르면 어떤 문제가 생기나?
  - 같은 클래스라도 서로 다른 클래스로 인식 → 싱글톤 깨지거나 ClassCastException 등 발생 가능
- 멀티모듈 구조가 클래스 로더 수에 영향을 주는가?
  - 클래스 로더 수는 실행 환경(WAS 등)에 따라 결정됨, 멀티모듈 여부와는 무관
- 스프링은 왜 싱글톤으로 객체를 관리할 수 있나?
  - IoC 컨테이너가 객체 생명주기를 관리하며, Bean을 한 번만 생성해서 캐싱하기 때문
